# Регулятор освещенности - решение задачи

В постановке задачи уже выдвигались требования к регулятору. После изучения задачи, теории по задаче, а также после изучения макета были сформулированы более конкретные требования.

Эти требования можно описать в виде следующей диаграммы:

![Требования к регулятору](/img/act-photo/problem-diagram.png)

Итак, требуется реализовать:

1. Два канала входного каскада для ввода сигнала с фотодиода $$x(t)$$ и сигнала опорного уровня $$r(t)$$, разность между которыми будет являться сигналом рассогласования $$e(t)$$ (см. [ПИД-регулятор](/theory/pid-controller.md)).
2. Выходной каскад для управления яркостью светодиода посредством ШИМ-сигнала (сигнала с широтно-импульсной модуляцией).
3. Алгоритм управления -- ПИД-регулятор.
4. Периферийные интерфейсы: `SPI`, `USART`, `I2C`.

После чего воплотить все это в виде печатной платы.

Будем рассматривать все по порядку.






## Выходной каскад

Выходной каскад в купе с алгоритмом управления предназначен для управления яркостью контролируемого светодиода. Яркостью можно управлять посредством ШИМ, что и используется. Частота ШИМ, получаемой с микроконтроллера, -- порядка нескольких килогерц.

На рис. показан выходной каскад. Он строился из единственного условия согласования уровней напряжения микроконтроллера и макета.

![Выходной каскад. Стрелками обозначено подключение через разъем](/img/act-photo/output-cascade.png)

Резисторы выбирались для обеспечения полного открытия транзистора при поступлении положительного импульса.

## Входные каскады

Для включения фотодиода был выбран генераторный режим включения на базе преобразователя ток-напряжение на ОУ (рис.).

![Преобразователь напряжение-ток](/img/act-photo/current-to-voltage.png)

После получения доступа к макету было выяснено, что       ток с фотодиода идет примерно 1мкА. В обратную связь ОУ был поставлен резистор на 1МОм, что обеспечило на выходе преобразователя положительные импульсы напряжения амплитудой примерно 1В.

Поскольку на фотодиод падает свет со светодиодов, яркостью которых управляет ШИМ-сигнал частотой порядка нескольких килогерц, а также присутствует наводка сети 50Гц от освещения в помещении, для получения среднего уровня освещенности требуется отфильтровать сигнал. Поэтому за преобразователем был поставлен фильтр Чебышева четвертого порядка с параметрами:

* Частота единичного усиления -- 20Гц
* Частота среза -- 50Гц
* Неравномерность ослабления в полосе пропускания -- 3дБ
* Ослабление на частоте среда -- 30дБ.

Фильтр синтезировался в `Micro Cap 9`. Он и его АЧХ и ФЧХ приведены на рис.

![Фильтр входного каскада](/img/act-photo/filter.png)

![АЧХ и ФЧХ фильтра](/img/act-photo/filter-response.png)

Однако после фильтра напряжение снова не превосходит 1В. А опорный уровень АЦП `ATmega8A` равен 2.56В, что означает, что минимальный код ($$0$$) будет соответствовать 0В, а максимальный код ($$2^{10}-1$$) будет соответствовать 2.56В. Чтобы напрасно не тратить больше половины диапазона АЦП, сигнал после фильтрации дополнительно усиливается усилителем в 2..2.5 раза.

Для контроля коэффициента усиления усилитель снабжен подстроечным резистором.

(Можно было бы совместить фильтрацию и усиление, однако такая практика не очень распространена.)

![Усилитель с подстроечным резистором](/img/act-photo/amplifier.png)

1. Воплощение в виде печатной платы
    * На базе микроконтроллера `ATmega8A`
    * С входами и выходами для:
        - Питания $$+12V$$
        - Преобразователя напряжения $$+12V \rightarrow \pm5V$$
        - Фотодиода (провод с макета)
        - Светодиода (провод с макета)
        - `USART`/`RS-232` -- отладка и обработка команд
        - `SPI` -- программирование памяти
        - `I2C` (потребуется для следующей задачи)
    * С защитой от переполюсовки питания
    * С кнопкой `RESET` для сброса микроконтроллера
    * С фильтро-усилительным входным каскадом, обеспечивающим:
        - Преобразование фототока фотодиода в напряжение
        - Фильтрацию сигнала с фотодиода -- отсечение частот, больших или равных 50Гц (наводки сети)
        - Усиление сигнала для заведения его на АЦП с диапазоном оцифровки 0..2.56В.
    * С входным каскадом установки опорного уровня освещенности, которую и необходимо поддерживать, обеспечивающим заведение сигнала опорного уровня на АЦП
2. 